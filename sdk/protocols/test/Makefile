# Makefile for linx protocols examples
# ç”¨äºç¼–è¯‘å’Œè¿è¡Œ linx åè®®ç¤ºä¾‹ç¨‹åº

# ç¼–è¯‘å™¨è®¾ç½®
CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -g -O2 -fPIC
LDFLAGS = -lm -lpthread

# ç›®å½•è®¾ç½®
PROTOCOLS_DIR = ../
EXAMPLES_DIR = .
BUILD_DIR = build
CJSON_DIR = ../../cjson
LOG_DIR = ../../log

# æºæ–‡ä»¶
PROTOCOL_SOURCES = $(PROTOCOLS_DIR)/linx_protocol.c $(PROTOCOLS_DIR)/linx_websocket.c
CJSON_SOURCES = $(CJSON_DIR)/cJSON.c $(CJSON_DIR)/cJSON_Utils.c
LOG_SOURCES = $(LOG_DIR)/linx_log.c
EXAMPLE_WEBSOCKET_SRC = example_linx_websocket.c

# ç›®æ ‡æ–‡ä»¶
EXAMPLE_WEBSOCKET_TARGET = $(BUILD_DIR)/example_linx_websocket

# åŒ…å«è·¯å¾„
INCLUDES = -I$(PROTOCOLS_DIR) -I$(CJSON_DIR)

# æ£€æµ‹æ“ä½œç³»ç»Ÿ
UNAME_S := $(shell uname -s)

# Mongoose ä¾èµ–æ£€æµ‹
MONGOOSE_FOUND = 0
MONGOOSE_CFLAGS = 
MONGOOSE_LIBS = 

# é¦–å…ˆå°è¯• pkg-config
ifneq ($(shell pkg-config --exists libmongoose 2>/dev/null; echo $$?), 0)
    # pkg-config å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨æŸ¥æ‰¾
    ifeq ($(UNAME_S),Darwin)
        # macOS ç³»ç»Ÿ
        ifneq ($(wildcard ../../third/mongoose/install/include/mongoose.h),)
            MONGOOSE_CFLAGS = -I../../third/mongoose/install/include
            MONGOOSE_LIBS = -L../../third/mongoose/install/lib -lmongoose
            MONGOOSE_FOUND = 1
        else ifneq ($(wildcard /opt/homebrew/include/mongoose.h),)
            MONGOOSE_CFLAGS = -I/opt/homebrew/include
            MONGOOSE_LIBS = -L/opt/homebrew/lib -lmongoose
            MONGOOSE_FOUND = 1
        else ifneq ($(wildcard /opt/homebrew/Cellar/mongoose/*/include/mongoose.h),)
            MONGOOSE_INCLUDE_DIR = $(shell find /opt/homebrew/Cellar/mongoose/*/include -name mongoose.h -exec dirname {} \; 2>/dev/null | head -1)
            MONGOOSE_LIB_DIR = $(shell find /opt/homebrew/Cellar/mongoose/*/lib -name "libmongoose.*" -exec dirname {} \; 2>/dev/null | head -1)
            ifneq ($(MONGOOSE_INCLUDE_DIR),)
                MONGOOSE_CFLAGS = -I$(MONGOOSE_INCLUDE_DIR)
                MONGOOSE_LIBS = -L$(MONGOOSE_LIB_DIR) -lmongoose
                MONGOOSE_FOUND = 1
            endif
        else ifneq ($(wildcard /usr/local/include/mongoose.h),)
            MONGOOSE_CFLAGS = -I/usr/local/include
            MONGOOSE_LIBS = -L/usr/local/lib -lmongoose
            MONGOOSE_FOUND = 1
        endif
    else
        # Linux ç³»ç»Ÿ
        ifneq ($(wildcard ../../third/mongoose/install/include/mongoose.h),)
            MONGOOSE_CFLAGS = -I../../third/mongoose/install/include
            MONGOOSE_LIBS = -L../../third/mongoose/install/lib -lmongoose
            MONGOOSE_FOUND = 1
        else ifneq ($(wildcard /usr/include/mongoose.h),)
            MONGOOSE_CFLAGS = -I/usr/include
            MONGOOSE_LIBS = -lmongoose
            MONGOOSE_FOUND = 1
        else ifneq ($(wildcard /usr/local/include/mongoose.h),)
            MONGOOSE_CFLAGS = -I/usr/local/include
            MONGOOSE_LIBS = -L/usr/local/lib -lmongoose
            MONGOOSE_FOUND = 1
        endif
    endif
else
    # pkg-config æˆåŠŸ
    MONGOOSE_CFLAGS = $(shell pkg-config --cflags libmongoose)
    MONGOOSE_LIBS = $(shell pkg-config --libs libmongoose)
    MONGOOSE_FOUND = 1
endif

# é»˜è®¤ç›®æ ‡
.PHONY: all clean help run-websocket run-all check-deps install-deps debug info

all: check-deps $(EXAMPLE_WEBSOCKET_TARGET)

# æ£€æŸ¥ä¾èµ–
check-deps:
	@echo "ğŸ” æ£€æŸ¥ç¼–è¯‘ä¾èµ–..."
	@echo "æ“ä½œç³»ç»Ÿ: $(UNAME_S)"
	@which $(CC) > /dev/null || (echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° $(CC) ç¼–è¯‘å™¨" && exit 1)
	@echo "âœ… $(CC) ç¼–è¯‘å™¨å·²å®‰è£…"
	@which make > /dev/null || (echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° make å·¥å…·" && exit 1)
	@echo "âœ… make å·¥å…·å·²å®‰è£…"
	@echo "æ£€æŸ¥ pthread æ”¯æŒ..."
	@echo '#include <pthread.h>\nint main(){return 0;}' | $(CC) -x c - -lpthread -o /tmp/pthread_test 2>/dev/null && rm -f /tmp/pthread_test && echo "âœ… pthread åº“å¯ç”¨" || (echo "âŒ pthread åº“ä¸å¯ç”¨" && exit 1)
	@echo "æ£€æŸ¥ cJSON æºæ–‡ä»¶..."
	@test -f "$(CJSON_DIR)/cJSON.c" && echo "âœ… cJSON æºæ–‡ä»¶å­˜åœ¨" || (echo "âŒ cJSON æºæ–‡ä»¶ä¸å­˜åœ¨: $(CJSON_DIR)/cJSON.c" && exit 1)
	@echo "æ£€æŸ¥åè®®æºæ–‡ä»¶..."
	@test -f "$(PROTOCOLS_DIR)/linx_protocol.c" && echo "âœ… linx_protocol.c å­˜åœ¨" || (echo "âŒ linx_protocol.c ä¸å­˜åœ¨: $(PROTOCOLS_DIR)/linx_protocol.c" && exit 1)
	@test -f "$(PROTOCOLS_DIR)/linx_websocket.c" && echo "âœ… linx_websocket.c å­˜åœ¨" || (echo "âŒ linx_websocket.c ä¸å­˜åœ¨: $(PROTOCOLS_DIR)/linx_websocket.c" && exit 1)
	@echo "æ£€æŸ¥ mongoose åº“..."
	@if [ "$(MONGOOSE_FOUND)" = "1" ]; then \
		echo "âœ… mongoose åº“å·²æ‰¾åˆ°"; \
		echo "   CFLAGS: $(MONGOOSE_CFLAGS)"; \
		echo "   LIBS: $(MONGOOSE_LIBS)"; \
	else \
		echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ° mongoose åº“ï¼ŒWebSocket ç¤ºä¾‹å°†æ— æ³•ç¼–è¯‘"; \
		echo "   å®‰è£…æ–¹æ³•:"; \
		echo "   macOS: brew install mongoose"; \
		echo "   Ubuntu/Debian: sudo apt-get install libmongoose-dev"; \
	fi
	@echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"

# å®‰è£…ä¾èµ–ï¼ˆä»…æç¤ºï¼‰
install-deps:
	@echo "ğŸ“¦ ä¾èµ–å®‰è£…æŒ‡å—"
	@echo "================"
	@echo ""
	@if [ "$(UNAME_S)" = "Darwin" ]; then \
		echo "macOS ç³»ç»Ÿ:"; \
		echo "  brew install mongoose"; \
		echo "  brew install pkg-config"; \
	elif [ "$(UNAME_S)" = "Linux" ]; then \
		echo "Ubuntu/Debian ç³»ç»Ÿ:"; \
		echo "  sudo apt-get update"; \
		echo "  sudo apt-get install libmongoose-dev pkg-config build-essential"; \
		echo ""; \
		echo "CentOS/RHEL ç³»ç»Ÿ:"; \
		echo "  sudo yum install mongoose-devel pkg-config gcc make"; \
	else \
		echo "å…¶ä»–ç³»ç»Ÿ: è¯·æ‰‹åŠ¨å®‰è£… mongoose åº“å’Œå¼€å‘å·¥å…·"; \
	fi

# åˆ›å»ºæ„å»ºç›®å½•
$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

# ç¼–è¯‘ linx_websocket ç¤ºä¾‹
$(EXAMPLE_WEBSOCKET_TARGET): $(EXAMPLE_WEBSOCKET_SRC) $(PROTOCOL_SOURCES) $(CJSON_SOURCES) $(LOG_SOURCES) | $(BUILD_DIR)
	@echo "ğŸ”¨ ç¼–è¯‘ linx_websocket ç¤ºä¾‹..."
	@echo "æºæ–‡ä»¶: $<"
	@echo "ä¾èµ–: $(PROTOCOL_SOURCES) $(CJSON_SOURCES) $(LOG_SOURCES)"
	@if [ "$(MONGOOSE_FOUND)" != "1" ]; then \
		echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° mongoose åº“"; \
		echo "è¯·è¿è¡Œ 'make install-deps' æŸ¥çœ‹å®‰è£…æ–¹æ³•"; \
		exit 1; \
	else \
		echo "ä½¿ç”¨ mongoose: $(MONGOOSE_CFLAGS) $(MONGOOSE_LIBS)"; \
		$(CC) $(CFLAGS) $(INCLUDES) $(MONGOOSE_CFLAGS) -o $@ $< $(PROTOCOL_SOURCES) $(CJSON_SOURCES) $(LOG_SOURCES) $(LDFLAGS) $(MONGOOSE_LIBS); \
		echo "âœ… linx_websocket ç¤ºä¾‹ç¼–è¯‘å®Œæˆ: $@"; \
	fi

# è¿è¡Œ linx_websocket ç¤ºä¾‹
run-websocket: $(EXAMPLE_WEBSOCKET_TARGET)
	@echo "ğŸš€ è¿è¡Œ linx_websocket ç¤ºä¾‹..."
	@echo "================================"
	@echo "æ³¨æ„: è¿™æ˜¯ä¸€ä¸ª WebSocket é•¿è¿æ¥ç¤ºä¾‹ï¼Œéœ€è¦ç½‘ç»œè¿æ¥"
	@echo "æŒ‰ Ctrl+C å¯ä»¥å®‰å…¨é€€å‡ºç¨‹åº"
	@$(EXAMPLE_WEBSOCKET_TARGET)

# è¿è¡Œæ‰€æœ‰ç¤ºä¾‹
run-all: run-websocket
	@echo ""
	@echo "ğŸ‰ æ‰€æœ‰å¯ç”¨ç¤ºä¾‹è¿è¡Œå®Œæˆï¼"

# è°ƒè¯•ä¿¡æ¯
debug:
	@echo "ğŸ› è°ƒè¯•ä¿¡æ¯"
	@echo "==========="
	@echo "CC: $(CC)"
	@echo "CFLAGS: $(CFLAGS)"
	@echo "LDFLAGS: $(LDFLAGS)"
	@echo "INCLUDES: $(INCLUDES)"
	@echo "PROTOCOLS_DIR: $(PROTOCOLS_DIR)"
	@echo "CJSON_DIR: $(CJSON_DIR)"
	@echo "BUILD_DIR: $(BUILD_DIR)"
	@echo "UNAME_S: $(UNAME_S)"
	@echo "MONGOOSE_FOUND: $(MONGOOSE_FOUND)"
	@echo "MONGOOSE_CFLAGS: $(MONGOOSE_CFLAGS)"
	@echo "MONGOOSE_LIBS: $(MONGOOSE_LIBS)"
	@echo ""
	@echo "æºæ–‡ä»¶:"
	@echo "  PROTOCOL_SOURCES: $(PROTOCOL_SOURCES)"
	@echo "  CJSON_SOURCES: $(CJSON_SOURCES)"
	@echo "  EXAMPLE_WEBSOCKET_SRC: $(EXAMPLE_WEBSOCKET_SRC)"
	@echo ""
	@echo "ç›®æ ‡æ–‡ä»¶:"
	@echo "  EXAMPLE_WEBSOCKET_TARGET: $(EXAMPLE_WEBSOCKET_TARGET)"

# æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
	@echo "ğŸ“‹ é¡¹ç›®ä¿¡æ¯"
	@echo "==========="
	@echo "é¡¹ç›®: linx åè®®ç¤ºä¾‹"
	@echo "ç‰ˆæœ¬: 1.0"
	@echo "æè¿°: æ¼”ç¤º linx åè®®å’Œ WebSocket é•¿è¿æ¥çš„ä½¿ç”¨"
	@echo ""
	@echo "ç¤ºä¾‹ç¨‹åº:"
	@echo "  example_linx_websocket  - WebSocket é•¿è¿æ¥ç¤ºä¾‹"
	@echo ""
	@echo "ä¾èµ–åº“:"
	@echo "  cJSON                   - JSON è§£æåº“"
	@echo "  mongoose                - HTTP/WebSocket åº“"
	@echo "  pthread                 - å¤šçº¿ç¨‹æ”¯æŒ"

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf $(BUILD_DIR)
	@rm -f *.o *.so *.dylib
	@rm -f core core.*
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸ“– linx åè®®ç¤ºä¾‹ Makefile å¸®åŠ©"
	@echo "================================"
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all              - ç¼–è¯‘æ‰€æœ‰ç¤ºä¾‹ç¨‹åº"
	@echo "  check-deps       - æ£€æŸ¥ç¼–è¯‘ä¾èµ–"
	@echo "  install-deps     - æ˜¾ç¤ºä¾èµ–å®‰è£…æŒ‡å—"
	@echo "  run-websocket    - ç¼–è¯‘å¹¶è¿è¡Œ linx_websocket ç¤ºä¾‹"
	@echo "  run-all          - è¿è¡Œæ‰€æœ‰å¯ç”¨ç¤ºä¾‹"
	@echo "  debug            - æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯"
	@echo "  info             - æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯"
	@echo "  clean            - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  help             - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ç¤ºä¾‹ç”¨æ³•:"
	@echo "  make                    # ç¼–è¯‘æ‰€æœ‰ç¤ºä¾‹"
	@echo "  make check-deps         # æ£€æŸ¥ä¾èµ–"
	@echo "  make install-deps       # æŸ¥çœ‹å®‰è£…æŒ‡å—"
	@echo "  make run-websocket      # è¿è¡Œ WebSocket ç¤ºä¾‹"
	@echo "  make run-all            # è¿è¡Œæ‰€æœ‰ç¤ºä¾‹"
	@echo "  make debug              # æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯"
	@echo "  make clean              # æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo ""
	@echo "ä¾èµ–è¦æ±‚:"
	@echo "  - gcc ç¼–è¯‘å™¨ (æ”¯æŒ C99)"
	@echo "  - pthread åº“"
	@echo "  - mongoose åº“ (ç”¨äº WebSocket ç¤ºä¾‹)"
	@echo "  - cJSON åº“ (å·²åŒ…å«æºç )"
	@echo ""
	@echo "æ•…éšœæ’é™¤:"
	@echo "  - å¦‚æœç¼–è¯‘å¤±è´¥ï¼Œè¿è¡Œ 'make check-deps' æ£€æŸ¥ä¾èµ–"
	@echo "  - å¦‚æœç¼ºå°‘ mongooseï¼Œè¿è¡Œ 'make install-deps' æŸ¥çœ‹å®‰è£…æ–¹æ³•"
	@echo "  - è¿è¡Œ 'make debug' æŸ¥çœ‹è¯¦ç»†çš„ç¼–è¯‘é…ç½®ä¿¡æ¯"

# é˜²æ­¢æ–‡ä»¶åå†²çª
.SUFFIXES:
.SECONDARY: